import random
from typing import List, Optional

from gsuid_core.logger import logger
from gsuid_core.ai_core.rag import query_knowledge
from gsuid_core.ai_core.models import KnowledgePoint

# æ’ä»¶åç§°
PLUGIN_NAME = "RH_ComfyUI"

# æ¨¡å‹çŸ¥è¯†åº“ - æç®€æ ¼å¼
MODEL_KNOWLEDGE = {
    "text2image": {
        "qwen_2512": {
            "title": "åƒé—®Qwen-Image2512",
            "content": "åƒé—®Image2512æ¨¡å‹ï¼Œæ“…é•¿ä¸­æ–‡æç¤ºè¯ç†è§£ï¼Œé€‚åˆå„ç§é£æ ¼çš„å›¾åƒç”Ÿæˆã€‚ä¼˜åŠ¿ï¼šä¸­æ–‡æç¤ºè¯ç†è§£èƒ½åŠ›å¼ºï¼Œæ”¯æŒå¤æ‚é£æ ¼æè¿°ï¼Œè¾“å‡ºè´¨é‡ç¨³å®šå¯é ã€‚é€‚ç”¨åœºæ™¯ï¼šä¸­æ–‡åœºæ™¯çš„å›¾åƒç”Ÿæˆï¼Œéœ€è¦ç²¾ç¡®æè¿°çš„ç”»é¢ï¼Œè‰ºæœ¯åˆ›ä½œå’Œæ’ç”»ã€‚æˆæœ¬ï¼šä½ï¼Œé€Ÿåº¦ï¼šä¸­ç­‰ï¼Œè¾“å‡ºè´¨é‡ï¼šä½ã€‚",
            "tags": ["ä¸­æ–‡", "å›¾åƒç”Ÿæˆ", "é«˜è´¨é‡", "è‰ºæœ¯åˆ›ä½œ", "æ–‡ç”Ÿå›¾"],
        },
        "banana2": {
            "title": "Gemini 3.1 Flash Image / Nano Bnana 2",
            "content": "Gemini 3.1 Flash å›¾åƒç”Ÿæˆæ¨¡å‹ï¼Œé€Ÿåº¦å¿«ï¼Œé€‚åˆå¿«é€Ÿç”Ÿæˆå’Œé¢„è§ˆã€‚ä¼˜åŠ¿ï¼šç”Ÿæˆé€Ÿåº¦éå¸¸å¿«ï¼Œæ”¯æŒå¿«é€Ÿè¿­ä»£æµ‹è¯•ï¼Œè´¨é‡ç¨³å®šå¯æ§ï¼Œé€‚åˆæ‰¹é‡ç”Ÿæˆã€‚é€‚ç”¨åœºæ™¯ï¼šå¿«é€Ÿé¢„è§ˆå’Œæµ‹è¯•ï¼Œä½å»¶è¿Ÿè¦æ±‚çš„åº”ç”¨ï¼Œæ‰¹é‡ç”Ÿæˆã€‚æˆæœ¬ï¼šä¸­ç­‰ï¼Œé€Ÿåº¦ï¼šå¿«ï¼Œè¾“å‡ºè´¨é‡ï¼šé«˜ã€‚",
            "tags": ["å¿«é€Ÿ", "å›¾åƒç”Ÿæˆ", "ä½å»¶è¿Ÿ", "æ‰¹é‡ç”Ÿæˆ", "æ–‡ç”Ÿå›¾"],
        },
        "banana_pro": {
            "title": "Nano Banana 1 Pro",
            "content": "Nano Banana 2.2K é«˜è´¨é‡å›¾åƒç”Ÿæˆæ¨¡å‹ã€‚ä¼˜åŠ¿ï¼šå›¾åƒè´¨é‡éå¸¸é«˜ï¼Œç»†èŠ‚ä¸°å¯Œç»†è…»ï¼Œè‰²å½©è¡¨ç°ä¼˜ç§€ï¼Œé€‚åˆä¸“ä¸šè¾“å‡ºã€‚é€‚ç”¨åœºæ™¯ï¼šéœ€è¦æœ€ç»ˆè¾“å‡ºçš„é«˜è´¨é‡å›¾åƒï¼Œä¸“ä¸šåˆ›ä½œåœºæ™¯ï¼Œå•†ä¸šé¡¹ç›®ï¼Œéœ€è¦ç²¾ç»†ç»†èŠ‚çš„ç”»é¢ã€‚æˆæœ¬ï¼šé«˜ï¼Œé€Ÿåº¦ï¼šä¸­ç­‰ï¼Œè¾“å‡ºè´¨é‡ï¼šæé«˜ã€‚",
            "tags": ["é«˜è´¨é‡", "å›¾åƒç”Ÿæˆ", "ä¸“ä¸š", "ç²¾ç»†", "æ–‡ç”Ÿå›¾"],
        },
    },
    "image2image": {
        "qwen_2512_img2img": {
            "title": "åƒé—®Qwen-Image2512 (å›¾ç”Ÿå›¾)",
            "content": "åƒé—®Image2512æ¨¡å‹ï¼Œæ“…é•¿ä¸­æ–‡æç¤ºè¯ç†è§£ï¼Œé€‚åˆå„ç§é£æ ¼çš„å›¾åƒç”Ÿæˆã€‚ä¼˜åŠ¿ï¼šä¸­æ–‡æç¤ºè¯ç†è§£èƒ½åŠ›å¼ºï¼Œæ”¯æŒå¤æ‚é£æ ¼æè¿°ï¼Œè¾“å‡ºè´¨é‡ç¨³å®šå¯é ã€‚é€‚ç”¨åœºæ™¯ï¼šä¸­æ–‡åœºæ™¯çš„å›¾åƒç”Ÿæˆï¼Œéœ€è¦ç²¾ç¡®æè¿°çš„ç”»é¢ï¼Œè‰ºæœ¯åˆ›ä½œå’Œæ’ç”»ã€‚æˆæœ¬ï¼šä½ï¼Œé€Ÿåº¦ï¼šä¸­ç­‰ï¼Œè¾“å‡ºè´¨é‡ï¼šä½ã€‚",
            "tags": ["ä¸­æ–‡", "å›¾ç”Ÿå›¾"],
        },
    },
    "image_edit": {
        "qwen_2511": {
            "title": "é€šä¹‰åƒé—® Edit 2511",
            "content": "ä¸“ä¸šçš„å›¾åƒç¼–è¾‘æ¨¡å‹ã€‚ä¼˜åŠ¿ï¼šä¸­æ–‡æŒ‡ä»¤ç†è§£å‡†ç¡®ï¼Œæ”¯æŒç²¾ç¡®çš„åŒºåŸŸç¼–è¾‘ï¼Œå¯åŒæ—¶å¤„ç†å¤šå›¾è¾“å…¥ã€‚é€‚ç”¨åœºæ™¯ï¼šå±€éƒ¨ä¿®å›¾å’Œç¼–è¾‘ï¼Œå¤šå›¾èåˆå¤„ç†ï¼Œç…§ç‰‡ç²¾ä¿®ï¼Œæ·»åŠ æˆ–åˆ é™¤å…ƒç´ ã€‚æˆæœ¬ï¼šä½ï¼Œé€Ÿåº¦ï¼šä¸­ç­‰ï¼Œè¾“å‡ºè´¨é‡ï¼šä½ã€‚",
            "tags": ["ä¸­æ–‡", "å›¾ç‰‡ç¼–è¾‘", "å¤šå›¾", "ç²¾ç¡®ç¼–è¾‘", "é£æ ¼è¿ç§»", "æ·»åŠ æ–‡å­—"],
        },
        "banana2": {
            "title": "Gemini 3.1 Flash Image / Nano Bnana 2",
            "content": "å¿«é€Ÿå›¾åƒç¼–è¾‘æ¨¡å‹ã€‚ä¼˜åŠ¿ï¼šå¤„ç†é€Ÿåº¦å¿«ï¼Œé€‚åˆå¿«é€Ÿç¼–è¾‘ã€‚é€‚ç”¨åœºæ™¯ï¼šè¾ƒä¸ºå¤æ‚çš„å›¾ç‰‡ä¿®æ”¹ã€‚æˆæœ¬ï¼šä¸­ï¼Œé€Ÿåº¦ï¼šå¿«ï¼Œè¾“å‡ºè´¨é‡ï¼šä¸­ç­‰ã€‚",
            "tags": ["å¿«é€Ÿ", "å›¾ç‰‡ç¼–è¾‘", "ç®€å•", "ç²¾ç»†ç¼–è¾‘", "ç”»é£ä¿®æ”¹"],
        },
        "banana_pro": {
            "title": "Nano Banana 2.2K Editor",
            "content": "é«˜è´¨é‡å›¾åƒç¼–è¾‘æ¨¡å‹ã€‚ä¼˜åŠ¿ï¼šç¼–è¾‘è´¨é‡é«˜ï¼Œç»†èŠ‚å¤„ç†å¥½ã€‚é€‚ç”¨åœºæ™¯ï¼šç²¾ç»†å›¾ç‰‡ç¼–è¾‘ï¼Œä¸“ä¸šä¿®å›¾ï¼Œéœ€è¦é«˜è´¨é‡è¾“å‡ºã€‚æˆæœ¬ï¼šé«˜ï¼Œé€Ÿåº¦ï¼šè¾ƒæ…¢ï¼Œè¾“å‡ºè´¨é‡ï¼šæé«˜ã€‚",
            "tags": ["é«˜è´¨é‡", "å›¾ç‰‡ç¼–è¾‘", "ä¸“ä¸š", "ç²¾ç»†ç¼–è¾‘"],
        },
    },
    "text2video": {
        "wan2.2_text2video": {
            "title": "Wan 2.2 Text2Video",
            "content": "æ–‡ç”Ÿè§†é¢‘æ¨¡å‹ã€‚ä¼˜åŠ¿ï¼šä¸­æ–‡æ”¯æŒè‰¯å¥½ï¼Œå¯ä»¥ç”Ÿæˆåˆ†è¾¨ç‡è¾ƒé«˜çš„è§†é¢‘ï¼ŒåŠ¨ä½œæµç•…ã€‚é€‚ç”¨åœºæ™¯ï¼šåˆ›æ„è§†é¢‘ç”Ÿæˆï¼ŒåŠ¨ç”»åˆ¶ä½œï¼ŒçŸ­è§†é¢‘åˆ›ä½œã€‚æˆæœ¬ï¼šé«˜ï¼Œé€Ÿåº¦ï¼šæ…¢ï¼Œè¾“å‡ºè´¨é‡ï¼šé«˜ã€‚",
            "tags": ["ä¸­æ–‡", "æ–‡ç”Ÿè§†é¢‘", "åŠ¨ç”»", "åˆ›æ„"],
        },
    },
    "image2video": {
        "wan2.2_img2video": {
            "title": "Wan 2.2 Image2Video",
            "content": "å›¾ç”Ÿè§†é¢‘æ¨¡å‹ã€‚ä¼˜åŠ¿ï¼šå¯ä»¥è®©é™æ€å›¾ç‰‡åŠ¨èµ·æ¥ï¼Œä¿æŒåŸå›¾é£æ ¼ï¼Œä¸­æ–‡æ”¯æŒè‰¯å¥½ã€‚é€‚ç”¨åœºæ™¯ï¼šè®©ç…§ç‰‡å˜ç”ŸåŠ¨ï¼Œåˆ¶ä½œå¾ªç¯åŠ¨ç”»ï¼ŒåŸºäºå›¾ç‰‡çš„çŸ­è§†é¢‘ã€‚æˆæœ¬ï¼šæé«˜ï¼Œé€Ÿåº¦ï¼šæ…¢ï¼Œè¾“å‡ºè´¨é‡ï¼šé«˜ã€‚",
            "tags": ["å›¾ç”Ÿè§†é¢‘", "åŠ¨ç”»", "è®©å›¾ç‰‡åŠ¨èµ·æ¥", "é£æ ¼ä¿æŒ"],
        },
    },
    "music": {
        "ace_step1.5": {
            "title": "ACE Step 1.5",
            "content": "éŸ³ä¹ç”Ÿæˆæ¨¡å‹ã€‚ä¼˜åŠ¿ï¼šå¯ä»¥ç”Ÿæˆå¤šç§é£æ ¼éŸ³ä¹ï¼Œæ”¯æŒæ­Œè¯è¾“å…¥ï¼ŒéŸ³ä¹è´¨é‡è¾ƒé«˜ã€‚é€‚ç”¨åœºæ™¯ï¼šèƒŒæ™¯éŸ³ä¹ç”Ÿæˆï¼Œåˆ›æ„éŸ³ä¹åˆ¶ä½œï¼Œé…ä¹éœ€æ±‚ã€‚æˆæœ¬ï¼šä¸­ç­‰ï¼Œé€Ÿåº¦ï¼šä¸­æ…¢ï¼Œè¾“å‡ºè´¨é‡ï¼šé«˜ã€‚",
            "tags": ["éŸ³ä¹ç”Ÿæˆ", "é£æ ¼å¤šæ ·", "æ­Œè¯æ”¯æŒ", "èƒŒæ™¯éŸ³ä¹"],
        },
    },
    "speech": {
        "IndexTTS2": {
            "title": "Index TTS 2",
            "content": "è¯­éŸ³åˆæˆæ¨¡å‹ã€‚ä¼˜åŠ¿ï¼šè¯­éŸ³è‡ªç„¶ï¼Œä¸­æ–‡å‘éŸ³å‡†ç¡®ï¼Œæ”¯æŒå¤šç§è¯­æ°”ã€‚é€‚ç”¨åœºæ™¯ï¼šæ–‡æœ¬è½¬è¯­éŸ³ï¼Œæœ‰å£°å†…å®¹åˆ¶ä½œï¼Œè¾…åŠ©é˜…è¯»ã€‚æˆæœ¬ï¼šä¸­ç­‰ï¼Œé€Ÿåº¦ï¼šå¿«ï¼Œè¾“å‡ºè´¨é‡ï¼šé«˜ã€‚",
            "tags": ["è¯­éŸ³åˆæˆ", "ä¸­æ–‡", "è‡ªç„¶è¯­éŸ³", "TTS"],
        },
    },
}


def get_model_knowledge_for_embedding() -> List[KnowledgePoint]:
    """è·å–æ‰€æœ‰æ¨¡å‹çŸ¥è¯†ï¼Œç”¨äºå¡«å……å‘é‡åº“

    Returns:
        æ¨¡å‹çŸ¥è¯†åˆ—è¡¨ï¼Œæ ¼å¼ï¼š{id, plugin, type, category, title, content, tags}
    """
    results = []
    for category in MODEL_KNOWLEDGE:
        for model in MODEL_KNOWLEDGE[category]:
            info = MODEL_KNOWLEDGE[category][model]
            results.append(
                {
                    "id": f"{PLUGIN_NAME}:model:{category}:{model}",
                    "plugin": PLUGIN_NAME,
                    "type": "model",
                    "category": category,
                    "title": info["title"],
                    "content": info["content"],
                    "tags": info["tags"],
                }
            )
    return results


def get_model_names_by_category(category: str):
    """è·å–æŒ‡å®šç±»åˆ«ä¸‹çš„æ‰€æœ‰æ¨¡å‹åç§°

    Args:
        category: æ¨¡å‹ç±»åˆ«

    Returns:
        æ¨¡å‹åç§°åˆ—è¡¨
    """
    return list(MODEL_KNOWLEDGE.get(category, {}).keys())


def get_all_categories():
    """è·å–æ‰€æœ‰æ¨¡å‹ç±»åˆ«

    Returns:
        ç±»åˆ«åˆ—è¡¨
    """
    return list(MODEL_KNOWLEDGE.keys())


async def recommend_model(
    query: str,
    category: str,
    limit: int = 3,
    fallback: bool = True,
) -> Optional[str]:
    """ä¸ºç‰¹å®šç±»åˆ«æ¨èæ¨¡å‹

    Args:
        query: ç”¨æˆ·éœ€æ±‚æè¿°
        category: æ¨¡å‹ç±»åˆ« (text2image, image2image, etc.)
        limit: æŸ¥è¯¢ç»“æœæ•°é‡
        fallback: å½“æ²¡æœ‰æ‰¾åˆ°åŒ¹é…æ—¶æ˜¯å¦å›é€€åˆ°éšæœºé€‰æ‹©

    Returns:
        æ¨èçš„æ¨¡å‹åç§°ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¸”fallback=Falseåˆ™è¿”å›None
    """
    results = await query_knowledge(
        query,
        category,
        limit=limit,
    )

    if not results:
        if fallback:
            models = get_model_names_by_category(category)
            if models:
                logger.info(f"ğŸ§  [{PLUGIN_NAME}][RAG] æœªæ‰¾åˆ°åŒ¹é…æ¨¡å‹ï¼Œéšæœºé€‰æ‹©: {category}")
                return random.choice(models)
        return None

    # é€‰æ‹©åˆ†æ•°æœ€é«˜çš„æ¨¡å‹
    best_model = sorted(results, key=lambda x: x.score, reverse=True)[0]
    if best_model.payload is None:
        return None

    model_id = best_model.payload.get("id")

    # ä»IDä¸­æå–æ¨¡å‹åç§°: RH_ComfyUI:model:text2image:qwen_2512 -> qwen_2512
    if model_id:
        model_name = model_id.split(":")[-1] if ":" in model_id else model_id
        model_display = best_model.payload.get("title", model_name)

        logger.info(f"ğŸ§  [{PLUGIN_NAME}][RAG] æ¨èæ¨¡å‹: {model_display} ({model_name}) åˆ†æ•°: {best_model.score:.4f}")

        return model_name
    return None
